=== Resume Hero Stage B Training (Schedule Fix) ===
Run tag: hero_resume
Resuming from checkpoint: runs/hero/ckpt_stageb
Saving to: runs/hero_resume/ckpt_stageb
Epochs: 8 (extended for consolidation)

SCHEDULE FIXES (based on v1 analysis):
  - LATENT_KEEP_END: 1.0 → 0.85 (freeze at sweet spot)
  - EPOCHS extended to 8 (consolidate with frozen dropout)
  - Peak checkpointing: train.py saves '_best' automatically

Analysis showed peak at keep_prob=0.6-0.85:
  - Peak: 19.4% first_acc at keep_prob=0.613
  - 26 steps achieved ≥10% (all at keep_prob 0.55-0.82)
  - Final eval (keep_prob=1.0) only 4.4% - model never learned full latents

Retained from v1:
  - FIRST_TOKEN_CE_WEIGHT=11.0
  - KD_WEIGHT=0.5
  - OOM fixes: expandable_segments, KD_TEACHER_CHUNK=1
  - Performance: TEXT_TEACHER_CHUNK=4

torch: 2.4.0+cu121 cuda: 12.1 available: True
CUDA_VISIBLE_DEVICES: 0,1,2,3
PYTORCH_CUDA_ALLOC_CONF: expandable_segments:True

=== Stage B: Training with frozen dropout (keep_prob→0.85) ===

/projects/m000066/sujinesh/LatentWire/.venv/lib/python3.9/site-packages/transformers/utils/hub.py:128: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
Loading dataset subset...
Loading SQuAD subset...
Downloading shards:   0%|          | 0/4 [00:00<?, ?it/s]Downloading shards: 100%|██████████| 4/4 [00:00<00:00, 2525.55it/s]
Loading checkpoint shards:   0%|          | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|██▌       | 1/4 [00:02<00:06,  2.06s/it]Loading checkpoint shards:  50%|█████     | 2/4 [00:03<00:03,  1.91s/it]Loading checkpoint shards:  75%|███████▌  | 3/4 [00:05<00:01,  1.59s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:05<00:00,  1.07s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:05<00:00,  1.34s/it]
[meta-llama/Meta-Llama-3.1-8B-Instruct] hf_device_map: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}
trainable params: 41,943,040 || all params: 8,072,204,288 || trainable%: 0.5196
/projects/m000066/sujinesh/LatentWire/.venv/lib/python3.9/site-packages/peft/mapping_func.py:73: UserWarning: You are trying to modify a model with PEFT for a second time. If you want to reload the model with a different config, make sure to call `.unload()` before.
  warnings.warn(
trainable params: 272,801,792 || all params: 8,345,006,080 || trainable%: 3.2690
Llama hidden size: 4096
[DeviceMap] Llama: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}
[INFO] llama anchor tokens: 3
⏪ Resuming from: runs/hero/ckpt_stageb
   -> start_epoch=0, global_step=0
[warmup] alternating text/latent for first 890 steps
Epoch 1/8
[warmup] step=0 mode=text (warm-up)
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)
  step  1/445 | (warm-up text) | align=0.0003 | text_tf=11.3445 | latent_scale=0.20
[warmup] step=1 mode=text (warm-up)
  step  2/445 | (warm-up text) | align=0.0003 | text_tf=10.7604 | latent_scale=0.20
[warmup] step=2 mode=text (warm-up)
  step  3/445 | (warm-up text) | align=0.0003 | text_tf=10.6791 | latent_scale=0.20
[warmup] step=3 mode=text (warm-up)
  step  4/445 | (warm-up text) | align=0.0003 | text_tf=11.3121 | latent_scale=0.20
[warmup] step=4 mode=text (warm-up)
  step  5/445 | (warm-up text) | align=0.0003 | text_tf=10.3264 | latent_scale=0.20
[warmup] step=5 mode=text (warm-up)
  step  6/445 | (warm-up text) | align=0.0003 | text_tf=10.3952 | latent_scale=0.20
[warmup] step=6 mode=text (warm-up)
  step  7/445 | (warm-up text) | align=0.0003 | text_tf=10.6840 | latent_scale=0.21
[warmup] step=7 mode=text (warm-up)
  step  8/445 | (warm-up text) | align=0.0003 | text_tf=11.2707 | latent_scale=0.21
[warmup] step=8 mode=text (warm-up)
  step  9/445 | (warm-up text) | align=0.0003 | text_tf=10.5088 | latent_scale=0.21
[warmup] step=9 mode=text (warm-up)
  step  10/445 | (warm-up text) | align=0.0003 | text_tf=10.7101 | latent_scale=0.21
  step  10/445 | grad_norm=0.00 | sec/step~7.12 | keep=0.50 | K=8 | llama(T): tf=2.5315 first=3.2240 kCE=2.5518 KD=0.0000 acc=0.000 state=8.4681 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=0.0000e+00 | K=8 tau=2.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  11/445 | (warm-up text) | align=0.0003 | text_tf=10.8913 | latent_scale=0.21
  step  12/445 | (warm-up text) | align=0.0003 | text_tf=10.8126 | latent_scale=0.21
  step  13/445 | (warm-up text) | align=0.0003 | text_tf=9.3048 | latent_scale=0.21
  step  14/445 | (warm-up text) | align=0.0003 | text_tf=9.2379 | latent_scale=0.21
  step  15/445 | (warm-up text) | align=0.0003 | text_tf=10.1597 | latent_scale=0.21
  step  16/445 | (warm-up text) | align=0.0003 | text_tf=9.8083 | latent_scale=0.21
  step  17/445 | (warm-up text) | align=0.0003 | text_tf=9.8454 | latent_scale=0.21
  step  18/445 | (warm-up text) | align=0.0003 | text_tf=9.7719 | latent_scale=0.22
  step  19/445 | (warm-up text) | align=0.0003 | text_tf=10.3056 | latent_scale=0.22
  step  20/445 | (warm-up text) | align=0.0003 | text_tf=9.2310 | latent_scale=0.22
  step  20/445 | grad_norm=0.00 | sec/step~6.62 | keep=0.50 | K=8 | llama(T): tf=2.4068 first=2.5042 kCE=2.2663 KD=0.0000 acc=0.000 state=8.9153 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=2.2737e-13 | K=8 tau=2.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  21/445 | (warm-up text) | align=0.0003 | text_tf=9.5714 | latent_scale=0.22
  step  22/445 | (warm-up text) | align=0.0003 | text_tf=9.8608 | latent_scale=0.22
  step  23/445 | (warm-up text) | align=0.0003 | text_tf=10.1429 | latent_scale=0.22
  step  24/445 | (warm-up text) | align=0.0003 | text_tf=9.7617 | latent_scale=0.22
  step  25/445 | (warm-up text) | align=0.0003 | text_tf=10.0703 | latent_scale=0.22
  step  26/445 | (warm-up text) | align=0.0003 | text_tf=9.8643 | latent_scale=0.22
  step  27/445 | (warm-up text) | align=0.0003 | text_tf=10.2411 | latent_scale=0.22
  step  28/445 | (warm-up text) | align=0.0003 | text_tf=9.7702 | latent_scale=0.22
  step  29/445 | (warm-up text) | align=0.0003 | text_tf=10.1698 | latent_scale=0.23
  step  30/445 | (warm-up text) | align=0.0003 | text_tf=9.9520 | latent_scale=0.23
  step  30/445 | grad_norm=0.00 | sec/step~7.04 | keep=0.50 | K=8 | llama(T): tf=2.4567 first=2.1841 kCE=2.6992 KD=0.0000 acc=0.000 state=9.4326 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=7.7149e-10 | K=8 tau=2.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  31/445 | (warm-up text) | align=0.0003 | text_tf=9.8542 | latent_scale=0.23
  step  32/445 | (warm-up text) | align=0.0003 | text_tf=10.5283 | latent_scale=0.23
  step  33/445 | (warm-up text) | align=0.0003 | text_tf=9.6906 | latent_scale=0.23
  step  34/445 | (warm-up text) | align=0.0003 | text_tf=9.8076 | latent_scale=0.23
  step  35/445 | (warm-up text) | align=0.0003 | text_tf=10.2855 | latent_scale=0.23
  step  36/445 | (warm-up text) | align=0.0003 | text_tf=9.9721 | latent_scale=0.23
  step  37/445 | (warm-up text) | align=0.0003 | text_tf=9.0692 | latent_scale=0.23
  step  38/445 | (warm-up text) | align=0.0003 | text_tf=9.2326 | latent_scale=0.23
  step  39/445 | (warm-up text) | align=0.0003 | text_tf=8.9431 | latent_scale=0.23
  step  40/445 | (warm-up text) | align=0.0003 | text_tf=9.0622 | latent_scale=0.24
  step  40/445 | grad_norm=0.00 | sec/step~6.91 | keep=0.50 | K=8 | llama(T): tf=2.4538 first=2.0946 kCE=2.7182 KD=0.0000 acc=0.028 state=9.1906 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.5476e-11 | K=8 tau=2.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  41/445 | (warm-up text) | align=0.0003 | text_tf=8.9199 | latent_scale=0.24
  step  42/445 | (warm-up text) | align=0.0003 | text_tf=9.1201 | latent_scale=0.24
  step  43/445 | (warm-up text) | align=0.0003 | text_tf=8.9576 | latent_scale=0.24
  step  44/445 | (warm-up text) | align=0.0003 | text_tf=9.0216 | latent_scale=0.24
  step  45/445 | (warm-up text) | align=0.0003 | text_tf=9.3301 | latent_scale=0.24
  step  46/445 | (warm-up text) | align=0.0003 | text_tf=8.7801 | latent_scale=0.24
  step  47/445 | (warm-up text) | align=0.0003 | text_tf=8.8154 | latent_scale=0.24
  step  48/445 | (warm-up text) | align=0.0003 | text_tf=9.5137 | latent_scale=0.24
