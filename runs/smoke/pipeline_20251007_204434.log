Starting GPU monitoring → runs/smoke/gpu_monitor.log

>>> Combination 1: m64_dz256_rl2_rh4
    RUN_TAG=smoke
    EPOCHS_STAGEA=4 | EPOCHS_STAGEB=8
    WARMUP_TEXT_LATENT_EPOCHS_STAGEA=2.0 | WARMUP_TEXT_LATENT_EPOCHS_STAGEB=1.5

=== CUDA preflight ===
torch: 2.4.0+cu121 cuda: 12.1 available: True
CUDA_VISIBLE_DEVICES: 0,1,2,3
PYTORCH_CUDA_ALLOC_CONF: expandable_segments:True

=== Stage A: Llama latent fit ===

/projects/m000066/sujinesh/LatentWire/.venv/lib/python3.9/site-packages/transformers/utils/hub.py:128: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
Loading dataset subset...
Loading SQuAD subset...
Downloading shards:   0%|          | 0/4 [00:00<?, ?it/s]Downloading shards: 100%|██████████| 4/4 [00:00<00:00, 1574.44it/s]
Loading checkpoint shards:   0%|          | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|██▌       | 1/4 [00:11<00:34, 11.57s/it]Loading checkpoint shards:  50%|█████     | 2/4 [00:21<00:20, 10.46s/it]Loading checkpoint shards:  75%|███████▌  | 3/4 [00:32<00:10, 10.71s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:34<00:00,  7.36s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:34<00:00,  8.62s/it]
[meta-llama/Meta-Llama-3.1-8B-Instruct] hf_device_map: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}
Llama hidden size: 4096
[DeviceMap] Llama: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}
[INFO] llama anchor tokens: 3
[INFO] LR scheduler: CosineAnnealingLR (T_max=160, eta_min=1.00e-06)
⚠️  No valid checkpoint found to resume; starting fresh.
[warmup] alternating text/latent for first 80 steps
Epoch 1/4
[warmup] step=0 mode=text (warm-up)
We detected that you are passing `past_key_values` as a tuple of tuples. This is deprecated and will be removed in v4.47. Please convert your cache or use an appropriate `Cache` class (https://huggingface.co/docs/transformers/kv_cache#legacy-cache-format)
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)
  step  1/40 | (warm-up text) | align=0.0002 | text_tf=14.4855 | latent_scale=0.00
[warmup] step=1 mode=text (warm-up)
  step  2/40 | (warm-up text) | align=0.0002 | text_tf=16.1272 | latent_scale=0.01
[warmup] step=2 mode=text (warm-up)
  step  3/40 | (warm-up text) | align=0.0002 | text_tf=15.7793 | latent_scale=0.01
[warmup] step=3 mode=text (warm-up)
  step  4/40 | (warm-up text) | align=0.0002 | text_tf=14.5327 | latent_scale=0.02
[warmup] step=4 mode=text (warm-up)
  step  5/40 | (warm-up text) | align=0.0002 | text_tf=13.0389 | latent_scale=0.03
[warmup] step=5 mode=text (warm-up)
  step  6/40 | (warm-up text) | align=0.0002 | text_tf=15.1051 | latent_scale=0.03
[warmup] step=6 mode=text (warm-up)
  step  7/40 | (warm-up text) | align=0.0002 | text_tf=16.4085 | latent_scale=0.04
[warmup] step=7 mode=text (warm-up)
  step  8/40 | (warm-up text) | align=0.0002 | text_tf=13.0293 | latent_scale=0.04
[warmup] step=8 mode=text (warm-up)
  step  9/40 | (warm-up text) | align=0.0002 | text_tf=12.3943 | latent_scale=0.05
[warmup] step=9 mode=text (warm-up)
  step  10/40 | (warm-up text) | align=0.0002 | text_tf=15.6244 | latent_scale=0.06
  step  10/40 | grad_norm=8.47 | sec/step~3.01 | lr=5.00e-05 | keep=0.70 | K=8 | first_w=6.00 | llama(T): tf=0.7361 first=0.7536 kCE=0.7444 KD=0.0000 acc=0.000 state=0.8141 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=0.0000e+00 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  11/40 | (warm-up text) | align=0.0002 | text_tf=14.0664 | latent_scale=0.06
  step  12/40 | (warm-up text) | align=0.0002 | text_tf=14.8144 | latent_scale=0.07
  step  13/40 | (warm-up text) | align=0.0002 | text_tf=14.4586 | latent_scale=0.07
  step  14/40 | (warm-up text) | align=0.0002 | text_tf=14.9016 | latent_scale=0.08
  step  15/40 | (warm-up text) | align=0.0002 | text_tf=14.8830 | latent_scale=0.09
  step  16/40 | (warm-up text) | align=0.0002 | text_tf=13.7346 | latent_scale=0.09
  step  17/40 | (warm-up text) | align=0.0002 | text_tf=14.2391 | latent_scale=0.10
  step  18/40 | (warm-up text) | align=0.0002 | text_tf=14.8206 | latent_scale=0.11
  step  19/40 | (warm-up text) | align=0.0002 | text_tf=13.7570 | latent_scale=0.11
  step  20/40 | (warm-up text) | align=0.0002 | text_tf=16.5459 | latent_scale=0.12
  step  20/40 | grad_norm=57.53 | sec/step~2.64 | lr=5.00e-05 | keep=0.70 | K=8 | first_w=6.00 | llama(T): tf=4.0822 first=3.7749 kCE=4.5300 KD=0.0000 acc=0.000 state=1.7167 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.2790e-13 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  21/40 | (warm-up text) | align=0.0002 | text_tf=15.1378 | latent_scale=0.12
  step  22/40 | (warm-up text) | align=0.0002 | text_tf=16.3563 | latent_scale=0.13
  step  23/40 | (warm-up text) | align=0.0002 | text_tf=13.4210 | latent_scale=0.14
  step  24/40 | (warm-up text) | align=0.0002 | text_tf=14.1630 | latent_scale=0.14
  step  25/40 | (warm-up text) | align=0.0002 | text_tf=13.8414 | latent_scale=0.15
  step  26/40 | (warm-up text) | align=0.0002 | text_tf=13.1276 | latent_scale=0.16
  step  27/40 | (warm-up text) | align=0.0002 | text_tf=15.3854 | latent_scale=0.16
  step  28/40 | (warm-up text) | align=0.0002 | text_tf=13.3194 | latent_scale=0.17
  step  29/40 | (warm-up text) | align=0.0002 | text_tf=14.0663 | latent_scale=0.17
  step  30/40 | (warm-up text) | align=0.0002 | text_tf=16.1783 | latent_scale=0.18
  step  30/40 | grad_norm=22.78 | sec/step~2.45 | lr=5.00e-05 | keep=0.71 | K=8 | first_w=6.00 | llama(T): tf=3.8687 first=3.6212 kCE=3.9794 KD=0.0000 acc=0.000 state=2.5496 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.4211e-14 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  31/40 | (warm-up text) | align=0.0002 | text_tf=15.9426 | latent_scale=0.19
  step  32/40 | (warm-up text) | align=0.0002 | text_tf=13.4469 | latent_scale=0.19
  step  33/40 | (warm-up text) | align=0.0002 | text_tf=15.4329 | latent_scale=0.20
  step  34/40 | (warm-up text) | align=0.0002 | text_tf=16.3707 | latent_scale=0.21
  step  35/40 | (warm-up text) | align=0.0002 | text_tf=14.3010 | latent_scale=0.21
  step  36/40 | (warm-up text) | align=0.0002 | text_tf=12.5061 | latent_scale=0.22
  step  37/40 | (warm-up text) | align=0.0002 | text_tf=13.8202 | latent_scale=0.23
  step  38/40 | (warm-up text) | align=0.0002 | text_tf=16.5941 | latent_scale=0.23
  step  39/40 | (warm-up text) | align=0.0002 | text_tf=13.2847 | latent_scale=0.24
  step  40/40 | (warm-up text) | align=0.0002 | text_tf=15.8213 | latent_scale=0.24
  step  40/40 | grad_norm=154.98 | sec/step~2.92 | lr=5.00e-05 | keep=0.72 | K=8 | first_w=6.00 | llama(T): tf=4.9707 first=5.1529 kCE=5.3674 KD=0.0000 acc=0.000 state=3.5362 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=2.2737e-13 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
Epoch 2/4
  step  1/40 | (warm-up text) | align=0.0002 | text_tf=12.9281 | latent_scale=0.25
  step  2/40 | (warm-up text) | align=0.0002 | text_tf=14.2565 | latent_scale=0.26
  step  3/40 | (warm-up text) | align=0.0002 | text_tf=15.2433 | latent_scale=0.26
NaN/Inf loss; skipping step
  step  4/40 | (warm-up text) | align=0.0002 | text_tf=14.6619 | latent_scale=0.26
  step  5/40 | (warm-up text) | align=0.0002 | text_tf=16.1332 | latent_scale=0.27
  step  6/40 | (warm-up text) | align=0.0002 | text_tf=16.1801 | latent_scale=0.28
  step  7/40 | (warm-up text) | align=0.0002 | text_tf=14.4366 | latent_scale=0.28
NaN/Inf loss; skipping step
  step  8/40 | (warm-up text) | align=0.0002 | text_tf=13.5555 | latent_scale=0.28
  step  9/40 | (warm-up text) | align=0.0002 | text_tf=13.2060 | latent_scale=0.29
  step  10/40 | (warm-up text) | align=0.0002 | text_tf=15.1295 | latent_scale=0.29
  step  10/40 | grad_norm=39.64 | sec/step~2.53 | lr=5.00e-05 | keep=0.73 | K=8 | first_w=6.00 | llama(T): tf=3.7370 first=2.7001 kCE=4.0159 KD=0.0000 acc=0.000 state=4.2837 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=2.2737e-13 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  11/40 | (warm-up text) | align=0.0002 | text_tf=14.7686 | latent_scale=0.30
  step  12/40 | (warm-up text) | align=0.0002 | text_tf=13.2492 | latent_scale=0.31
  step  13/40 | (warm-up text) | align=0.0002 | text_tf=15.7726 | latent_scale=0.31
  step  14/40 | (warm-up text) | align=0.0002 | text_tf=14.1155 | latent_scale=0.32
  step  15/40 | (warm-up text) | align=0.0002 | text_tf=15.2746 | latent_scale=0.33
  step  16/40 | (warm-up text) | align=0.0002 | text_tf=15.4035 | latent_scale=0.33
  step  17/40 | (warm-up text) | align=0.0002 | text_tf=14.0975 | latent_scale=0.34
  step  18/40 | (warm-up text) | align=0.0002 | text_tf=15.9093 | latent_scale=0.34
  step  19/40 | (warm-up text) | align=0.0002 | text_tf=14.0969 | latent_scale=0.35
  step  20/40 | (warm-up text) | align=0.0002 | text_tf=13.8809 | latent_scale=0.36
  step  20/40 | grad_norm=14.43 | sec/step~2.87 | lr=4.99e-05 | keep=0.74 | K=8 | first_w=6.00 | llama(T): tf=4.7715 first=4.0723 kCE=4.6313 KD=0.0000 acc=0.000 state=5.1653 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=0.0000e+00 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  21/40 | (warm-up text) | align=0.0002 | text_tf=14.9103 | latent_scale=0.36
  step  22/40 | (warm-up text) | align=0.0002 | text_tf=14.8124 | latent_scale=0.37
  step  23/40 | (warm-up text) | align=0.0002 | text_tf=15.0112 | latent_scale=0.38
NaN/Inf loss; skipping step
  step  24/40 | (warm-up text) | align=0.0002 | text_tf=16.2561 | latent_scale=0.38
  step  25/40 | (warm-up text) | align=0.0002 | text_tf=14.5942 | latent_scale=0.38
  step  26/40 | (warm-up text) | align=0.0002 | text_tf=14.4382 | latent_scale=0.39
  step  27/40 | (warm-up text) | align=0.0002 | text_tf=14.6890 | latent_scale=0.39
  step  28/40 | (warm-up text) | align=0.0002 | text_tf=15.7008 | latent_scale=0.40
  step  29/40 | (warm-up text) | align=0.0002 | text_tf=14.6046 | latent_scale=0.41
  step  30/40 | (warm-up text) | align=0.0002 | text_tf=14.1358 | latent_scale=0.41
  step  30/40 | grad_norm=4.29 | sec/step~2.82 | lr=4.99e-05 | keep=0.76 | K=8 | first_w=6.00 | llama(T): tf=5.6487 first=4.6221 kCE=5.5834 KD=0.0000 acc=0.000 state=6.4448 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.1511e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  31/40 | (warm-up text) | align=0.0002 | text_tf=14.9751 | latent_scale=0.42
  step  32/40 | (warm-up text) | align=0.0002 | text_tf=13.4846 | latent_scale=0.42
  step  33/40 | (warm-up text) | align=0.0002 | text_tf=13.9267 | latent_scale=0.43
  step  34/40 | (warm-up text) | align=0.0002 | text_tf=13.5820 | latent_scale=0.44
  step  35/40 | (warm-up text) | align=0.0002 | text_tf=16.6273 | latent_scale=0.44
  step  36/40 | (warm-up text) | align=0.0002 | text_tf=13.6528 | latent_scale=0.45
  step  37/40 | (warm-up text) | align=0.0002 | text_tf=13.3147 | latent_scale=0.46
  step  38/40 | (warm-up text) | align=0.0002 | text_tf=16.6543 | latent_scale=0.46
  step  39/40 | (warm-up text) | align=0.0002 | text_tf=14.0652 | latent_scale=0.47
  step  40/40 | (warm-up text) | align=0.0002 | text_tf=13.1268 | latent_scale=0.47
  step  40/40 | grad_norm=25.43 | sec/step~2.48 | lr=4.98e-05 | keep=0.77 | K=8 | first_w=6.00 | llama(T): tf=6.3671 first=5.5802 kCE=6.4753 KD=0.0000 acc=0.000 state=6.9582 align=0.0002 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.1511e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
Epoch 3/4
  step  1/40 | (warm-up text) | align=0.0002 | text_tf=15.0335 | latent_scale=0.48
  step  2/40 | (warm-up text) | align=0.0002 | text_tf=14.0832 | latent_scale=0.49
  step  3/40 | (warm-up text) | align=0.0002 | text_tf=13.8411 | latent_scale=0.49
  step  10/40 | grad_norm=29.40 | sec/step~3.55 | lr=4.98e-05 | keep=0.79 | K=8 | first_w=6.00 | llama(L): tf=13.3550 first=11.3048 kCE=13.1263 KD=4.6626 acc=0.000 state=16.2712 align=0.0000 latA=0.5006 latP=0.2486 | scale_pen(llama)=1.1511e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  20/40 | grad_norm=32.00 | sec/step~3.49 | lr=4.98e-05 | keep=0.82 | K=8 | first_w=6.00 | llama(L): tf=12.4400 first=10.5845 kCE=12.4821 KD=4.5760 acc=0.000 state=16.3127 align=0.0000 latA=0.4991 latP=0.2486 | scale_pen(llama)=1.2790e-13 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  30/40 | grad_norm=6.32 | sec/step~3.20 | lr=4.97e-05 | keep=0.84 | K=8 | first_w=6.00 | llama(L): tf=11.3548 first=9.2449 kCE=11.8169 KD=4.6537 acc=0.000 state=15.8780 align=0.0000 latA=0.4980 latP=0.2482 | scale_pen(llama)=1.4211e-14 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  40/40 | grad_norm=38.17 | sec/step~3.52 | lr=4.96e-05 | keep=0.87 | K=8 | first_w=6.00 | llama(L): tf=11.9502 first=11.2886 kCE=12.0559 KD=4.4945 acc=0.000 state=16.1908 align=0.0000 latA=0.4990 latP=0.2482 | scale_pen(llama)=3.5527e-15 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
Epoch 4/4
  step  10/40 | grad_norm=14.92 | sec/step~3.20 | lr=4.96e-05 | keep=0.90 | K=8 | first_w=6.00 | llama(L): tf=11.2962 first=9.3996 kCE=11.9484 KD=4.3129 acc=0.000 state=15.5565 align=0.0000 latA=0.4985 latP=0.2478 | scale_pen(llama)=3.5527e-15 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  20/40 | grad_norm=6.19 | sec/step~3.72 | lr=4.95e-05 | keep=0.93 | K=8 | first_w=6.00 | llama(L): tf=10.2644 first=9.4049 kCE=10.6858 KD=4.6164 acc=0.000 state=15.3780 align=0.0000 latA=0.4995 latP=0.2476 | scale_pen(llama)=9.0949e-13 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  step  30/40 | grad_norm=5.00 | sec/step~2.94 | lr=4.94e-05 | keep=0.96 | K=8 | first_w=6.00 | llama(L): tf=10.7985 first=9.0064 kCE=11.7877 KD=4.6943 acc=0.042 [✓'a'] state=14.2594 align=0.0000 latA=0.5018 latP=0.2476 | scale_pen(llama)=1.7195e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
NaN/Inf loss; skipping step
  🌟 NEW PEAK: first_acc_ema=1.2% (raw_batch=4.2%) at step 154 → saved to runs/smoke/ckpt/stageA_best
      Sample predictions (first 5):
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='gren'
        ✗ pred='a' | gold='f'
        ✗ pred='a' | gold='200'
        ✗ pred='a' | gold='minor'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  step  40/40 | grad_norm=23.66 | sec/step~3.67 | lr=4.93e-05 | keep=1.00 | K=8 | first_w=6.00 | llama(L): tf=11.2290 first=9.9836 kCE=12.0859 KD=4.4202 acc=0.042 [✓'a'] state=14.5713 align=0.0000 latA=0.4999 latP=0.2473 | scale_pen(llama)=2.7853e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0000 rms_cal~0.0106 embed_rms~0.01058]
  🌟 NEW PEAK: first_acc_ema=1.4% (raw_batch=4.2%) at step 156 → saved to runs/smoke/ckpt/stageA_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='24'
        ✗ pred='a' | gold='Apple'
        ✗ pred='a' | gold='�'
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='C'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
[checkpoint] Freed 3.4KB before save.
[checkpoint] Saved latest: encoder.pt, state.pt, config.json, adapter_llama.pt, deep_prefix_llama.pt, refiner.pt
[checkpoint] Freed 0.0B after save (non-canonical).
✅ Saved latest checkpoint to runs/smoke/ckpt/stageA
📝 Saved training_stats.json: {'llama': {'rms_mean_raw': 1.000028570741415, 'rms_mean_cal': 0.010571459075435996, 'embed_rms': 0.01057521253824234, 'count': 160}}

=== Stage B: Llama prefix training + warm-up ===

/projects/m000066/sujinesh/LatentWire/.venv/lib/python3.9/site-packages/transformers/utils/hub.py:128: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
Loading dataset subset...
Loading SQuAD subset...
Downloading shards:   0%|          | 0/4 [00:00<?, ?it/s]Downloading shards: 100%|██████████| 4/4 [00:00<00:00, 363.51it/s]
Loading checkpoint shards:   0%|          | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|██▌       | 1/4 [00:02<00:07,  2.51s/it]Loading checkpoint shards:  50%|█████     | 2/4 [00:04<00:04,  2.17s/it]Loading checkpoint shards:  75%|███████▌  | 3/4 [00:06<00:02,  2.04s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:06<00:00,  1.38s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:06<00:00,  1.67s/it]
[meta-llama/Meta-Llama-3.1-8B-Instruct] hf_device_map: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}

🔧 Applying LoRA (r=8, alpha=8)...
   Llama BEFORE LoRA: 0 trainable / 8,030,261,248 total
trainable params: 6,815,744 || all params: 8,037,076,992 || trainable%: 0.0848
   Llama AFTER LoRA:  6,815,744 trainable / 8,037,076,992 total
   ✓ Added 6,815,744 LoRA parameters to Llama
Llama hidden size: 4096
[DeviceMap] Llama: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}
[INFO] llama anchor tokens: 3
[INFO] LR scheduler: CosineAnnealingLR (T_max=320, eta_min=1.00e-06)
⏪ Resuming from: runs/smoke/ckpt/stageA/state.pt
   -> loaded encoder/adapters/deep_prefix/refiner FROM state.pt
   -> restored RNG state
   -> reset epoch/global_step to zero as requested
   -> start_epoch=0, global_step=0
[warmup] alternating text/latent for first 60 steps
Epoch 1/8
[warmup] step=0 mode=text (warm-up)
We detected that you are passing `past_key_values` as a tuple of tuples. This is deprecated and will be removed in v4.47. Please convert your cache or use an appropriate `Cache` class (https://huggingface.co/docs/transformers/kv_cache#legacy-cache-format)
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)
  step  1/40 | (warm-up text) | align=0.0003 | text_tf=14.4855 | latent_scale=0.20
[warmup] step=1 mode=text (warm-up)
  step  2/40 | (warm-up text) | align=0.0003 | text_tf=16.1272 | latent_scale=0.21
[warmup] step=2 mode=text (warm-up)
  step  3/40 | (warm-up text) | align=0.0003 | text_tf=15.7793 | latent_scale=0.23
[warmup] step=3 mode=text (warm-up)
  step  4/40 | (warm-up text) | align=0.0003 | text_tf=14.5327 | latent_scale=0.24
[warmup] step=4 mode=text (warm-up)
  step  5/40 | (warm-up text) | align=0.0003 | text_tf=13.0389 | latent_scale=0.25
[warmup] step=5 mode=text (warm-up)
  step  6/40 | (warm-up text) | align=0.0003 | text_tf=15.1051 | latent_scale=0.27
[warmup] step=6 mode=text (warm-up)
  step  7/40 | (warm-up text) | align=0.0003 | text_tf=16.4085 | latent_scale=0.28
[warmup] step=7 mode=text (warm-up)
  step  8/40 | (warm-up text) | align=0.0003 | text_tf=13.0293 | latent_scale=0.29
[warmup] step=8 mode=text (warm-up)
  step  9/40 | (warm-up text) | align=0.0003 | text_tf=12.3943 | latent_scale=0.31
[warmup] step=9 mode=text (warm-up)
  step  10/40 | (warm-up text) | align=0.0003 | text_tf=15.6244 | latent_scale=0.32
  step  10/40 | grad_norm=2.91 | sec/step~6.08 | lr=5.00e-05 | keep=0.50 | K=8 | first_w=6.00 | llama(T): tf=3.4095 first=3.0092 kCE=3.6925 KD=0.0000 acc=0.083 state=7.5829 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=2.7853e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  step  11/40 | (warm-up text) | align=0.0003 | text_tf=14.0664 | latent_scale=0.33
  step  12/40 | (warm-up text) | align=0.0003 | text_tf=14.8144 | latent_scale=0.35
  step  13/40 | (warm-up text) | align=0.0003 | text_tf=14.1399 | latent_scale=0.36
  step  14/40 | (warm-up text) | align=0.0003 | text_tf=14.7764 | latent_scale=0.37
  step  15/40 | (warm-up text) | align=0.0003 | text_tf=14.5639 | latent_scale=0.39
  step  16/40 | (warm-up text) | align=0.0003 | text_tf=13.5347 | latent_scale=0.40
  step  17/40 | (warm-up text) | align=0.0003 | text_tf=13.8838 | latent_scale=0.41
  step  18/40 | (warm-up text) | align=0.0003 | text_tf=14.4741 | latent_scale=0.43
  step  19/40 | (warm-up text) | align=0.0003 | text_tf=13.4158 | latent_scale=0.44
  step  20/40 | (warm-up text) | align=0.0003 | text_tf=16.1965 | latent_scale=0.45
  step  20/40 | grad_norm=10.16 | sec/step~6.28 | lr=5.00e-05 | keep=0.50 | K=8 | first_w=6.00 | llama(T): tf=4.7058 first=3.9468 kCE=5.0266 KD=0.0000 acc=0.000 state=9.8366 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.6139e-09 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  step  21/40 | (warm-up text) | align=0.0003 | text_tf=14.7384 | latent_scale=0.47
  step  22/40 | (warm-up text) | align=0.0003 | text_tf=16.1045 | latent_scale=0.48
  step  23/40 | (warm-up text) | align=0.0003 | text_tf=13.0921 | latent_scale=0.49
  step  24/40 | (warm-up text) | align=0.0003 | text_tf=13.8979 | latent_scale=0.51
  step  25/40 | (warm-up text) | align=0.0003 | text_tf=12.8016 | latent_scale=0.52
  step  26/40 | (warm-up text) | align=0.0003 | text_tf=12.3551 | latent_scale=0.53
  step  27/40 | (warm-up text) | align=0.0003 | text_tf=14.2571 | latent_scale=0.55
  step  28/40 | (warm-up text) | align=0.0003 | text_tf=12.3171 | latent_scale=0.56
  step  29/40 | (warm-up text) | align=0.0003 | text_tf=13.1007 | latent_scale=0.57
  step  30/40 | (warm-up text) | align=0.0003 | text_tf=14.9512 | latent_scale=0.59
  step  30/40 | grad_norm=25.77 | sec/step~5.78 | lr=5.00e-05 | keep=0.50 | K=8 | first_w=6.00 | llama(T): tf=7.7799 first=6.7716 kCE=8.1859 KD=0.0000 acc=0.000 state=12.8785 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=1.5223e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  step  31/40 | (warm-up text) | align=0.0003 | text_tf=14.9643 | latent_scale=0.60
  step  32/40 | (warm-up text) | align=0.0003 | text_tf=12.6973 | latent_scale=0.61
  step  33/40 | (warm-up text) | align=0.0003 | text_tf=14.4743 | latent_scale=0.63
  step  34/40 | (warm-up text) | align=0.0003 | text_tf=15.3790 | latent_scale=0.64
  step  35/40 | (warm-up text) | align=0.0003 | text_tf=13.0504 | latent_scale=0.65
  step  36/40 | (warm-up text) | align=0.0003 | text_tf=11.4892 | latent_scale=0.67
  step  37/40 | (warm-up text) | align=0.0003 | text_tf=11.5427 | latent_scale=0.68
  step  38/40 | (warm-up text) | align=0.0003 | text_tf=13.7081 | latent_scale=0.69
  step  39/40 | (warm-up text) | align=0.0003 | text_tf=11.3406 | latent_scale=0.71
  step  40/40 | (warm-up text) | align=0.0003 | text_tf=12.8453 | latent_scale=0.72
  step  40/40 | grad_norm=15.35 | sec/step~6.10 | lr=5.00e-05 | keep=0.51 | K=8 | first_w=6.00 | llama(T): tf=8.3638 first=7.4697 kCE=8.9130 KD=0.0000 acc=0.000 state=16.7974 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=7.8479e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
Epoch 2/8
  step  1/40 | (warm-up text) | align=0.0003 | text_tf=9.8808 | latent_scale=0.73
  step  2/40 | (warm-up text) | align=0.0003 | text_tf=10.5109 | latent_scale=0.75
  step  3/40 | (warm-up text) | align=0.0003 | text_tf=12.1028 | latent_scale=0.76
NaN/Inf loss; skipping step
  step  4/40 | (warm-up text) | align=0.0003 | text_tf=10.4173 | latent_scale=0.76
  step  5/40 | (warm-up text) | align=0.0003 | text_tf=12.3274 | latent_scale=0.77
  step  6/40 | (warm-up text) | align=0.0003 | text_tf=12.3462 | latent_scale=0.79
  step  7/40 | (warm-up text) | align=0.0003 | text_tf=10.1740 | latent_scale=0.80
NaN/Inf loss; skipping step
  step  8/40 | (warm-up text) | align=0.0003 | text_tf=10.5932 | latent_scale=0.80
  step  9/40 | (warm-up text) | align=0.0003 | text_tf=10.4873 | latent_scale=0.81
  step  10/40 | (warm-up text) | align=0.0003 | text_tf=10.8122 | latent_scale=0.83
  step  10/40 | grad_norm=17.81 | sec/step~5.88 | lr=5.00e-05 | keep=0.51 | K=8 | first_w=6.00 | llama(T): tf=9.1857 first=7.3896 kCE=9.7775 KD=0.0000 acc=0.000 state=19.4862 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=7.8479e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  step  11/40 | (warm-up text) | align=0.0003 | text_tf=11.8958 | latent_scale=0.84
  step  12/40 | (warm-up text) | align=0.0003 | text_tf=10.9580 | latent_scale=0.85
  step  13/40 | (warm-up text) | align=0.0003 | text_tf=9.0925 | latent_scale=0.87
  step  14/40 | (warm-up text) | align=0.0003 | text_tf=9.3397 | latent_scale=0.88
  step  15/40 | (warm-up text) | align=0.0003 | text_tf=11.2258 | latent_scale=0.89
  step  16/40 | (warm-up text) | align=0.0003 | text_tf=10.3423 | latent_scale=0.91
  step  17/40 | (warm-up text) | align=0.0003 | text_tf=10.7299 | latent_scale=0.92
  step  18/40 | (warm-up text) | align=0.0003 | text_tf=10.1175 | latent_scale=0.93
  step  19/40 | (warm-up text) | align=0.0003 | text_tf=10.9669 | latent_scale=0.95
  step  20/40 | (warm-up text) | align=0.0003 | text_tf=11.0175 | latent_scale=0.96
  step  20/40 | grad_norm=19.60 | sec/step~6.05 | lr=5.00e-05 | keep=0.51 | K=8 | first_w=6.00 | llama(T): tf=10.9603 first=8.3540 kCE=11.1645 KD=0.0000 acc=0.000 state=21.5492 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=9.6806e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  step  21/40 | (warm-up text) | align=0.0003 | text_tf=9.6631 | latent_scale=0.97
  step  22/40 | (warm-up text) | align=0.0003 | text_tf=10.1669 | latent_scale=0.99
NaN/Inf loss; skipping step
[warmup] step=60 mode=text (tail)
  step  24/40 | (tail text) | align=0.0003 | text_tf=11.6497 | latent_scale=1.00
[warmup] step=66 mode=text (tail)
  step  30/40 | (tail text) | align=0.0003 | text_tf=10.1686 | latent_scale=1.00
  step  30/40 | grad_norm=11.12 | sec/step~5.08 | lr=5.00e-05 | keep=0.52 | K=8 | first_w=6.00 | llama(T): tf=10.5444 first=8.3882 kCE=10.9481 KD=0.0000 acc=0.000 state=22.6573 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=6.2074e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
[warmup] step=68 mode=text (tail)
  step  32/40 | (tail text) | align=0.0003 | text_tf=9.2716 | latent_scale=1.00
[warmup] step=71 mode=text (tail)
  step  35/40 | (tail text) | align=0.0003 | text_tf=10.9018 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=1.1% (raw_batch=4.2%) at step 74 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='200' | gold='for'
        ✗ pred='200' | gold='Russian'
        ✗ pred='200' | gold='Detroit'
        ✗ pred='200' | gold='The'
        ✗ pred='200' | gold='on'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: '200'(21) 'a'(3) 
  step  40/40 | grad_norm=7.31 | sec/step~4.38 | lr=4.99e-05 | keep=0.52 | K=8 | first_w=6.00 | llama(L): tf=10.5675 first=9.3987 kCE=11.4524 KD=4.9245 acc=0.042 [✓'200'] state=20.4012 align=0.0000 latA=0.9955 latP=0.4974 | scale_pen(llama)=3.4120e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=1.2% (raw_batch=4.2%) at step 77 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='200' | gold='83'
        ✗ pred='200' | gold='allow'
        ✗ pred='200' | gold='$'
        ✗ pred='200' | gold='spec'
        ✗ pred='200' | gold='LED'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: '200'(24) 
Epoch 3/8
[warmup] step=78 mode=text (tail)
  step  2/40 | (tail text) | align=0.0003 | text_tf=9.3615 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=1.3% (raw_batch=4.2%) at step 81 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='3'
        ✗ pred='a' | gold='de'
        ✗ pred='a' | gold='more'
        ✗ pred='a' | gold='Council'
        ✗ pred='a' | gold='compression'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  🌟 NEW PEAK: first_acc_ema=1.6% (raw_batch=4.2%) at step 82 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='195'
        ✗ pred='a' | gold='London'
        ✗ pred='a' | gold='late'
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='$'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
[warmup] step=85 mode=text (tail)
  step  9/40 | (tail text) | align=0.0003 | text_tf=10.1391 | latent_scale=1.00
[warmup] step=86 mode=text (tail)
  step  10/40 | (tail text) | align=0.0003 | text_tf=8.7618 | latent_scale=1.00
  step  10/40 | grad_norm=18.25 | sec/step~5.76 | lr=4.99e-05 | keep=0.53 | K=8 | first_w=6.00 | llama(T): tf=9.8881 first=8.6054 kCE=10.4482 KD=0.0000 acc=0.042 state=21.8682 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=3.4120e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=2.1% (raw_batch=8.3%) at step 89 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='ag'
        ✗ pred='a' | gold='email'
        ✗ pred='a' | gold='ev'
        ✗ pred='a' | gold='Exec'
        ✗ pred='a' | gold='WB'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  🌟 NEW PEAK: first_acc_ema=2.3% (raw_batch=4.2%) at step 90 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='long'
        ✗ pred='a' | gold='order'
        ✗ pred='a' | gold='V'
        ✗ pred='a' | gold='J'
        ✗ pred='a' | gold='US'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  🌟 NEW PEAK: first_acc_ema=2.5% (raw_batch=8.3%) at step 93 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='Class'
        ✗ pred='a' | gold='172'
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='May'
        ✗ pred='a' | gold='154'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  step  20/40 | grad_norm=9.87 | sec/step~4.28 | lr=4.99e-05 | keep=0.53 | K=8 | first_w=6.00 | llama(L): tf=10.2830 first=8.4962 kCE=10.8110 KD=4.3530 acc=0.083 [✓'a'] state=20.2195 align=0.0000 latA=0.9999 latP=0.4970 | scale_pen(llama)=3.3049e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=2.5% (raw_batch=8.3%) at step 97 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='no'
        ✗ pred='a' | gold='was'
        ✗ pred='a' | gold='acid'
        ✗ pred='a' | gold='Country'
        ✗ pred='a' | gold='Nor'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
[warmup] step=100 mode=text (tail)
  step  24/40 | (tail text) | align=0.0003 | text_tf=9.8550 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=2.6% (raw_batch=4.2%) at step 103 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='184'
        ✗ pred='a' | gold='King'
        ✗ pred='a' | gold='civil'
        ✗ pred='a' | gold='cases'
        ✗ pred='a' | gold='155'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
[warmup] step=103 mode=text (tail)
  step  27/40 | (tail text) | align=0.0003 | text_tf=9.2068 | latent_scale=1.00
  step  30/40 | grad_norm=9.46 | sec/step~4.03 | lr=4.99e-05 | keep=0.54 | K=8 | first_w=6.00 | llama(L): tf=9.9903 first=7.7972 kCE=10.6475 KD=4.4257 acc=0.042 [✓'a'] state=19.9265 align=0.0000 latA=0.9989 latP=0.4962 | scale_pen(llama)=4.2286e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=2.9% (raw_batch=8.3%) at step 110 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='men'
        ✗ pred='a' | gold='is'
        ✗ pred='a' | gold='142'
        ✗ pred='a' | gold='external'
        ✗ pred='a' | gold='during'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  step  40/40 | grad_norm=8.77 | sec/step~4.07 | lr=4.98e-05 | keep=0.55 | K=8 | first_w=6.00 | llama(L): tf=10.5196 first=10.0026 kCE=10.7228 KD=4.4872 acc=0.000 state=20.2735 align=0.0000 latA=0.9962 latP=0.4957 | scale_pen(llama)=5.0310e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
Epoch 4/8
  step  10/40 | (tail text) | align=0.0003 | text_tf=8.5692 | latent_scale=1.00
  step  10/40 | grad_norm=21.47 | sec/step~5.94 | lr=4.98e-05 | keep=0.56 | K=8 | first_w=6.00 | llama(T): tf=10.3619 first=7.9566 kCE=11.0373 KD=0.0000 acc=0.000 state=20.4803 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=5.0310e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0001 rms_cal~0.0106 embed_rms~0.01057]
  step  20/40 | grad_norm=12.52 | sec/step~4.85 | lr=4.98e-05 | keep=0.57 | K=8 | first_w=6.00 | llama(L): tf=9.6677 first=7.9750 kCE=10.0358 KD=4.3624 acc=0.000 state=20.8181 align=0.0000 latA=1.0008 latP=0.4948 | scale_pen(llama)=3.1974e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=2.9% (raw_batch=8.3%) at step 145 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='C'
        ✗ pred='the' | gold='signal'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='177'
        ✗ pred='the' | gold='These'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  30/40 | grad_norm=9.89 | sec/step~4.37 | lr=4.98e-05 | keep=0.58 | K=8 | first_w=6.00 | llama(L): tf=10.0549 first=7.7406 kCE=10.7108 KD=4.2714 acc=0.042 [✓'the'] state=19.6364 align=0.0000 latA=1.0010 latP=0.4945 | scale_pen(llama)=8.6459e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  step  31/40 | (tail text) | align=0.0003 | text_tf=9.4227 | latent_scale=1.00
  step  32/40 | (tail text) | align=0.0003 | text_tf=8.3782 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=3.1% (raw_batch=8.3%) at step 150 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='V'
        ✗ pred='the' | gold='limitations'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='as'
        ✗ pred='the' | gold='neo'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'the'(23) 'three'(1) 
NaN/Inf loss; skipping step
  🌟 NEW PEAK: first_acc_ema=3.8% (raw_batch=12.5%) at step 152 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='ban'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='little'
        ✗ pred='the' | gold='War'
        ✗ pred='the' | gold='N'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'the'(22) 'three'(2) 
  step  37/40 | (tail text) | align=0.0003 | text_tf=9.7177 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=4.6% (raw_batch=12.5%) at step 154 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='a'
        ✗ pred='the' | gold='gren'
        ✗ pred='the' | gold='f'
        ✗ pred='the' | gold='200'
        ✗ pred='the' | gold='minor'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  40/40 | grad_norm=7.46 | sec/step~3.95 | lr=4.97e-05 | keep=0.59 | K=8 | first_w=6.00 | llama(L): tf=10.5129 first=8.4004 kCE=11.0631 KD=4.1556 acc=0.042 [✓'the'] state=19.9114 align=0.0000 latA=0.9999 latP=0.4937 | scale_pen(llama)=1.6270e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
Epoch 5/8
  🌟 NEW PEAK: first_acc_ema=4.9% (raw_batch=8.3%) at step 157 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='Hotel'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='a'
        ✗ pred='the' | gold='83'
        ✗ pred='the' | gold='goal'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.7% (raw_batch=12.5%) at step 158 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='Int'
        ✗ pred='the' | gold='Gran'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='ann'
        ✗ pred='the' | gold='194'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  3/40 | (tail text) | align=0.0003 | text_tf=8.9081 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=12.5%) at step 161 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='as'
        ✗ pred='the' | gold='California'
        ✗ pred='the' | gold='Pr'
        ✗ pred='the' | gold='invalid'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 163 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='phot'
        ✗ pred='the' | gold='Ze'
        ✗ pred='the' | gold='142'
        ✗ pred='the' | gold='S'
        ✗ pred='the' | gold='standard'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  10/40 | grad_norm=26.95 | sec/step~3.88 | lr=4.97e-05 | keep=0.60 | K=8 | first_w=6.00 | llama(L): tf=9.9644 first=7.9003 kCE=10.4510 KD=4.2892 acc=0.000 state=20.1059 align=0.0000 latA=1.0037 latP=0.4937 | scale_pen(llama)=1.6270e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 171 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='3'
        ✗ pred='the' | gold='over'
        ✗ pred='the' | gold='a'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='High'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=16.7%) at step 172 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='medical'
        ✗ pred='the' | gold='198'
        ✗ pred='the' | gold='F'
        ✗ pred='the' | gold='200'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  20/40 | grad_norm=10.02 | sec/step~5.75 | lr=4.97e-05 | keep=0.61 | K=8 | first_w=6.00 | llama(L): tf=9.5871 first=7.1430 kCE=9.9645 KD=4.0653 acc=0.000 state=21.0646 align=0.0000 latA=0.9935 latP=0.4929 grad_tf=8.531e-03 grad_first=1.684e-02 grad_kce=8.877e-03 grad_kd=2.991e-03 grad_latent_align=3.188e-03 grad_latent_prefix_align=3.254e-04 | scale_pen(llama)=1.0027e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  step  27/40 | (tail text) | align=0.0003 | text_tf=8.1553 | latent_scale=1.00
  step  29/40 | (tail text) | align=0.0003 | text_tf=9.8932 | latent_scale=1.00
  step  30/40 | grad_norm=13.88 | sec/step~5.19 | lr=4.96e-05 | keep=0.62 | K=8 | first_w=6.00 | llama(L): tf=9.4152 first=7.4199 kCE=10.2201 KD=3.8157 acc=0.000 state=22.0685 align=0.0000 latA=0.9995 latP=0.4919 | scale_pen(llama)=1.3657e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  step  34/40 | (tail text) | align=0.0003 | text_tf=8.3874 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=12.5%) at step 192 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='to'
        ✗ pred='the' | gold='Ot'
        ✗ pred='the' | gold='S'
        ✗ pred='the' | gold='M'
        ✗ pred='the' | gold='23'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  37/40 | (tail text) | align=0.0003 | text_tf=8.7637 | latent_scale=1.00
  step  39/40 | (tail text) | align=0.0003 | text_tf=8.4456 | latent_scale=1.00
  step  40/40 | grad_norm=6.04 | sec/step~5.47 | lr=4.95e-05 | keep=0.64 | K=8 | first_w=6.00 | llama(L): tf=8.9153 first=6.8958 kCE=9.5837 KD=4.1396 acc=0.000 state=20.9458 align=0.0000 latA=0.9942 latP=0.4920 | scale_pen(llama)=5.9121e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
Epoch 6/8
  step  10/40 | grad_norm=22.62 | sec/step~4.26 | lr=4.95e-05 | keep=0.65 | K=8 | first_w=6.00 | llama(L): tf=8.9677 first=7.2392 kCE=9.6823 KD=4.3886 acc=0.000 state=20.3194 align=0.0000 latA=0.9989 latP=0.4920 | scale_pen(llama)=5.9121e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 210 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='its'
        ✗ pred='a' | gold='child'
        ✗ pred='a' | gold='83'
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='san'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'a'(23) 'the'(1) 
  step  20/40 | grad_norm=14.08 | sec/step~3.92 | lr=4.95e-05 | keep=0.66 | K=8 | first_w=6.00 | llama(L): tf=9.1726 first=6.3993 kCE=9.1324 KD=4.0767 acc=0.042 [✓'a'] state=21.0550 align=0.0000 latA=0.9950 latP=0.4918 | scale_pen(llama)=1.1130e-10 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  step  23/40 | (tail text) | align=0.0003 | text_tf=9.0595 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 221 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='bee'
        ✗ pred='the' | gold='children'
        ✗ pred='the' | gold='single'
        ✗ pred='the' | gold='sc'
        ✗ pred='the' | gold='H'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'the'(22) 'a'(2) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 222 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='g'
        ✗ pred='the' | gold='North'
        ✗ pred='a' | gold='An'
        ✗ pred='the' | gold='Green'
        ✓ pred='the' | gold='the'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'the'(23) 'a'(1) 
  step  28/40 | (tail text) | align=0.0003 | text_tf=8.8895 | latent_scale=1.00
  step  30/40 | grad_norm=6.50 | sec/step~5.32 | lr=4.94e-05 | keep=0.68 | K=8 | first_w=6.00 | llama(L): tf=9.4281 first=7.3355 kCE=9.7204 KD=4.1997 acc=0.000 state=18.2440 align=0.0000 latA=0.9984 latP=0.4909 grad_tf=9.934e-03 grad_first=1.862e-02 grad_kce=1.099e-02 grad_kd=3.270e-03 grad_latent_align=3.188e-03 grad_latent_prefix_align=3.254e-04 | scale_pen(llama)=9.3237e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 227 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='a'
        ✗ pred='the' | gold='75'
        ✗ pred='the' | gold='Comm'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='mill'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=12.5%) at step 230 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='Class'
        ✗ pred='the' | gold='spec'
        ✗ pred='the' | gold='4'
        ✗ pred='the' | gold='art'
        ✗ pred='the' | gold='Ar'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=12.5%) at step 233 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='six'
        ✗ pred='the' | gold='op'
        ✗ pred='the' | gold='St'
        ✗ pred='the' | gold='Central'
        ✗ pred='the' | gold='There'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  39/40 | (tail text) | align=0.0003 | text_tf=8.0309 | latent_scale=1.00
  step  40/40 | grad_norm=7.05 | sec/step~4.04 | lr=4.93e-05 | keep=0.70 | K=8 | first_w=6.00 | llama(L): tf=9.2020 first=6.9376 kCE=9.5947 KD=4.0347 acc=0.042 [✓'the'] state=19.4096 align=0.0000 latA=0.9947 latP=0.4904 | scale_pen(llama)=1.1951e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
Epoch 7/8
  step  6/40 | (tail text) | align=0.0003 | text_tf=9.8981 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=12.5%) at step 245 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='Cr'
        ✗ pred='the' | gold='Greek'
        ✗ pred='the' | gold='l'
        ✗ pred='the' | gold='World'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  10/40 | grad_norm=13.09 | sec/step~3.93 | lr=4.93e-05 | keep=0.71 | K=8 | first_w=6.00 | llama(L): tf=9.3823 first=6.9555 kCE=9.8850 KD=3.7822 acc=0.083 [✓'the'] state=22.4517 align=0.0000 latA=1.0009 latP=0.4904 | scale_pen(llama)=1.1951e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 246 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='B'
        ✗ pred='the' | gold='Nor'
        ✗ pred='the' | gold='President'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='two'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 247 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='184'
        ✗ pred='the' | gold='great'
        ✗ pred='the' | gold='War'
        ✗ pred='the' | gold='Mid'
        ✗ pred='the' | gold='non'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 253 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='201'
        ✗ pred='the' | gold='its'
        ✗ pred='the' | gold='bit'
        ✗ pred='the' | gold='European'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  20/40 | (tail text) | align=0.0003 | text_tf=8.1795 | latent_scale=1.00
  step  20/40 | grad_norm=8.89 | sec/step~5.73 | lr=4.93e-05 | keep=0.73 | K=8 | first_w=6.00 | llama(T): tf=9.1854 first=7.1763 kCE=9.7209 KD=0.0000 acc=0.042 state=20.5704 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=6.7658e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 257 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='hack'
        ✗ pred='the' | gold='British'
        ✗ pred='the' | gold='po'
        ✗ pred='the' | gold='cell'
        ✗ pred='the' | gold='C'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 258 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='in'
        ✗ pred='the' | gold='fre'
        ✗ pred='the' | gold='Tro'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='C'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=12.5%) at step 259 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='3'
        ✗ pred='the' | gold='Spanish'
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='November'
        ✗ pred='the' | gold='Order'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  30/40 | (tail text) | align=0.0003 | text_tf=9.1790 | latent_scale=1.00
  step  30/40 | grad_norm=8.74 | sec/step~5.39 | lr=4.92e-05 | keep=0.75 | K=8 | first_w=6.00 | llama(T): tf=8.7727 first=6.9921 kCE=8.7056 KD=0.0000 acc=0.083 state=21.6391 align=0.0003 latA=0.0000 latP=0.0000 | scale_pen(llama)=7.3669e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 267 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='K'
        ✗ pred='the' | gold='p'
        ✗ pred='the' | gold='$'
        ✗ pred='the' | gold='British'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 274 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='the' | gold='244'
        ✗ pred='the' | gold='198'
        ✗ pred='the' | gold='H'
        ✗ pred='the' | gold='sub'
        ✗ pred='the' | gold='Al'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  40/40 | grad_norm=6.74 | sec/step~5.43 | lr=4.91e-05 | keep=0.77 | K=8 | first_w=6.00 | llama(L): tf=9.0193 first=6.8029 kCE=9.3987 KD=4.3861 acc=0.042 [✓'the'] state=20.8769 align=0.0000 latA=0.9911 latP=0.4888 grad_tf=1.026e-02 grad_first=2.044e-02 grad_kce=1.148e-02 grad_kd=4.212e-03 grad_latent_align=3.188e-03 grad_latent_prefix_align=3.253e-04 | scale_pen(llama)=1.4211e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
Epoch 8/8
  step  7/40 | (tail text) | align=0.0003 | text_tf=8.9957 | latent_scale=1.00
  step  10/40 | grad_norm=22.99 | sec/step~4.11 | lr=4.91e-05 | keep=0.79 | K=8 | first_w=6.00 | llama(L): tf=9.2206 first=7.3753 kCE=9.2899 KD=4.2364 acc=0.000 state=20.7659 align=0.0000 latA=0.9947 latP=0.4882 | scale_pen(llama)=1.4211e-12 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 288 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='the' | gold='the'
        ✗ pred='the' | gold='195'
        ✗ pred='the' | gold='5'
        ✗ pred='the' | gold='196'
        ✗ pred='the' | gold='Em'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'the'(24) 
  step  13/40 | (tail text) | align=0.0003 | text_tf=9.1518 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 294 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='198' | gold='Pub'
        ✗ pred='the' | gold='University'
        ✗ pred='a' | gold='such'
        ✗ pred='198' | gold='William'
        ✗ pred='198' | gold='Sele'
      Prediction diversity: 3/24 unique tokens
      Top-3 predictions: '198'(16) 'the'(6) 'a'(2) 
  step  20/40 | grad_norm=11.22 | sec/step~5.09 | lr=4.90e-05 | keep=0.81 | K=8 | first_w=6.00 | llama(L): tf=8.6601 first=7.1952 kCE=9.1249 KD=3.9581 acc=0.000 state=20.5411 align=0.0000 latA=0.9906 latP=0.4881 | scale_pen(llama)=1.0360e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 299 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='198' | gold='a'
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='January'
        ✗ pred='198' | gold='any'
        ✗ pred='a' | gold='is'
      Prediction diversity: 3/24 unique tokens
      Top-3 predictions: '198'(12) 'a'(7) 'the'(5) 
  step  30/40 | grad_norm=10.60 | sec/step~4.96 | lr=4.89e-05 | keep=0.83 | K=8 | first_w=6.00 | llama(L): tf=8.6839 first=7.0136 kCE=9.4012 KD=4.2145 acc=0.000 state=19.9456 align=0.0000 latA=0.9910 latP=0.4872 | scale_pen(llama)=3.6962e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 307 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='An'
        ✗ pred='198' | gold='201'
        ✗ pred='a' | gold='En'
        ✗ pred='198' | gold='North'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'a'(13) '198'(11) 
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 309 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='email'
        ✗ pred='a' | gold='Int'
        ✗ pred='a' | gold='World'
        ✗ pred='198' | gold='few'
        ✗ pred='198' | gold='171'
      Prediction diversity: 2/24 unique tokens
      Top-3 predictions: 'a'(15) '198'(9) 
  step  35/40 | (tail text) | align=0.0003 | text_tf=8.4469 | latent_scale=1.00
  🌟 NEW PEAK: first_acc_ema=5.9% (raw_batch=8.3%) at step 314 → saved to runs/smoke/ckpt/stageB_best
      Sample predictions (first 5):
        ✗ pred='a' | gold='172'
        ✗ pred='a' | gold='$'
        ✓ pred='a' | gold='a'
        ✗ pred='a' | gold='North'
        ✗ pred='a' | gold='141'
      Prediction diversity: 1/24 unique tokens
      Top-3 predictions: 'a'(24) 
  step  39/40 | (tail text) | align=0.0003 | text_tf=7.7681 | latent_scale=1.00
  step  40/40 | grad_norm=6.36 | sec/step~4.55 | lr=4.88e-05 | keep=0.85 | K=8 | first_w=6.00 | llama(L): tf=9.1534 first=6.8593 kCE=9.5975 KD=3.6408 acc=0.042 [✓'a'] state=20.4908 align=0.0000 latA=0.9910 latP=0.4871 | scale_pen(llama)=2.8141e-11 | K=8 tau=4.00 | stats=[llama: rms_raw~1.0002 rms_cal~0.0106 embed_rms~0.01057]
[checkpoint] Freed 3.7KB before save.
[checkpoint] Saved latest: encoder.pt, state.pt, config.json, adapter_llama.pt, deep_prefix_llama.pt, refiner.pt
[checkpoint] Freed 0.0B after save (non-canonical).
✅ Saved latest checkpoint to runs/smoke/ckpt/stageB
📝 Saved LoRA adapters for Llama
📝 Saved training_stats.json: {'llama': {'rms_mean_raw': 1.0002159595489502, 'rms_mean_cal': 0.010570837231352926, 'embed_rms': 0.010568082332611084, 'count': 320}}

=== Stage C: Evaluation (Llama only) ===

/projects/m000066/sujinesh/LatentWire/.venv/lib/python3.9/site-packages/transformers/utils/hub.py:128: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
Auto-detected device: cuda
Loaded training_stats.json: runs/smoke/ckpt/stageB/training_stats.json
Encoder input alignment: mode=neutral_chat | strip_anchor=yes | samples=200
Building encoder and computing Z...

[Standard Evaluation Mode]
(Use --sequential_eval to enable per-model encoder text auto-alignment.)
Downloading shards:   0%|          | 0/4 [00:00<?, ?it/s]Downloading shards: 100%|██████████| 4/4 [00:00<00:00, 2717.84it/s]
Loading checkpoint shards:   0%|          | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|██▌       | 1/4 [00:01<00:04,  1.42s/it]Loading checkpoint shards:  50%|█████     | 2/4 [00:03<00:03,  1.79s/it]Loading checkpoint shards:  75%|███████▌  | 3/4 [00:05<00:01,  1.69s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:05<00:00,  1.15s/it]Loading checkpoint shards: 100%|██████████| 4/4 [00:05<00:00,  1.34s/it]
[meta-llama/Meta-Llama-3.1-8B-Instruct] hf_device_map: {'model.embed_tokens': 0, 'model.rotary_emb': 0, 'model.layers.0': 0, 'model.layers.1': 0, 'model.layers.2': 0, 'model.layers.3': 0, 'model.layers.4': 0, 'model.layers.5': 0, 'model.layers.6': 0, 'model.layers.7': 0, 'model.layers.8': 1, 'model.layers.9': 1, 'model.layers.10': 1, 'model.layers.11': 1, 'model.layers.12': 1, 'model.layers.13': 1, 'model.layers.14': 1, 'model.layers.15': 1, 'model.layers.16': 2, 'model.layers.17': 2, 'model.layers.18': 2, 'model.layers.19': 2, 'model.layers.20': 2, 'model.layers.21': 2, 'model.layers.22': 2, 'model.layers.23': 2, 'model.layers.24': 3, 'model.layers.25': 3, 'model.layers.26': 3, 'model.layers.27': 3, 'model.layers.28': 3, 'model.layers.29': 3, 'model.layers.30': 3, 'model.layers.31': 3, 'model.norm': 3, 'lm_head': 3}
✓ Loaded deep prefix generator for llama
Starting from v4.46, the `logits` model output will have the same type as the model (except at train time, where it will always be FP32)
We detected that you are passing `past_key_values` as a tuple of tuples. This is deprecated and will be removed in v4.47. Please convert your cache or use an appropriate `Cache` class (https://huggingface.co/docs/transformers/kv_cache#legacy-cache-format)

— Text baseline summary:
llama: EM=0.590 F1=0.794
✓ Loaded LoRA adapters for llama

==== LatentWire Evaluation ====
Dataset: squad
Samples: 200  |  Max new tokens: 16
Device: cuda  |  Dtype: bfloat16
Avg prompt tokens (Llama): 246.0 | (Qwen): - | Latent length M: 64
Compression ratio (Llama): 3.8x | (Qwen): -x
Approx interlingua payload per example: 13107200 bytes (fp32); fp16 reference: 6553600 bytes; fp32 reference: 13107200 bytes
latent/text bytes (one-copy, fp16): n/a

— Baseline: Text prompting
Llama  EM: 0.590  F1: 0.794  |  NLL/token (gold): 13.675748455854526
Wall clock: 10.31s

— Latent prompting (shared interlingua)
Llama  EM: 0.000  F1: 0.000  |  NLL/token (gold): 9.527284669767973
       First-token acc: top1=0.020  top5=0.045
Wall clock: 2.45s

— Token-budget baseline (mode: content_only)
Llama  EM: 0.010  F1: 0.063
Wall clock: 2.58s

— 2-LLM joint (rescored pick on latent runs)
Joint metrics unavailable (single-model evaluation).

==== METRICS_JSON ====
{
  "samples": 200,
  "max_new_tokens": 16,
  "latent_len": 64,
  "device": "cuda",
  "dtype": "torch.bfloat16",
  "avg_prompt_tokens": {
    "llama": 246.03
  },
  "compression": {
    "llama": 3.84421875
  },
  "payload_bytes": 13107200,
  "payload_bytes_detail": {
    "fp32": 13107200,
    "fp16": 6553600,
    "selected": null
  },
  "wire": {
    "prompt_chars": {
      "llama": 251558
    },
    "prompt_count": 200,
    "latent_shape": [
      200,
      64,
      256
    ],
    "latent_bytes": {
      "fp32": 13107200,
      "fp16": 6553600
    },
    "group_size": 32,
    "scale_bits": 16,
    "selected_latent_bytes": null,
    "wire_ratio": {}
  },
  "text": {
    "llama": {
      "em": 0.59,
      "f1": 0.7936993517504416,
      "nll_token": 13.675748455854526
    },
    "wall_clock_sec": 10.312953233718872
  },
  "latent": {
    "llama": {
      "em": 0.0,
      "f1": 0.0,
      "nll": 9.527284669767973,
      "first_token_top1": 0.02,
      "first_token_top5": 0.045,
      "nll_token": 9.527284669767973
    },
    "wall_clock_sec": 2.4473092555999756
  },
  "token_budget": {
    "mode": "content_only",
    "k": 64,
    "llama": {
      "em": 0.01,
      "f1": 0.06337241856366438
    },
    "wall_clock_sec": 2.5771071910858154
  },
  "joint": {
    "em": null,
    "f1": null,
    "agreement": null,
    "oracle": {
      "em": 0.0,
      "f1": 0.0
    }
  },
  "debug": {
    "llama": {
      "latent_anchor_text": "Answer: "
    },
    "settings": {
      "latent_anchor_mode": "chat",
      "latent_anchor_text": "Answer: ",
      "prefix_gain": 1.1,
      "calibration_mode": "embed_rms",
      "append_bos_after_prefix": "yes",
      "decode": {
        "min_new_tokens": 1,
        "eos_ban_steps": 0,
        "first_token_top_p": 1.0,
        "first_token_temperature": 0.0
      }
    }
  },
  "oracle": {
    "em": 0.0,
    "f1": 0.0
  },
  "dataset": "squad"
}
Stopping GPU monitoring (PID 2487967)
